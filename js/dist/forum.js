(()=>{var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e),t.d(e,{components:()=>N,extend:()=>E,utils:()=>P});const r=flarum.core.compat["forum/app"];var n=t.n(r);const o=flarum.core.compat["common/extend"],i=flarum.core.compat["forum/states/DiscussionListState"];var s=t.n(i);const c=flarum.core.compat["forum/components/DiscussionListItem"];var a=t.n(c);function u(t,e){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},u(t,e)}const l=flarum.core.compat["common/Component"];var p=t.n(l);const d=flarum.core.compat["common/utils/string"];function f(t,e){var r=(new DOMParser).parseFromString(t,"text/html"),n=e,o=function(t){if(n<=0){if("IMG"===t.nodeName||"PICTURE"===t.nodeName)return;var e,r;if(t.nodeType===Node.TEXT_NODE)return void(null==(e=t.parentNode)||e.removeChild(t));t.childNodes.length>0&&Array.from(t.childNodes).forEach(o),0===t.childNodes.length&&"IMG"!==t.nodeName&&"PICTURE"!==t.nodeName&&(null==(r=t.parentNode)||r.removeChild(t))}else if(t.nodeType!==Node.TEXT_NODE)Array.from(t.childNodes).forEach(o);else{var i,s,c,a=null!=(i=null==(s=t.textContent)?void 0:s.length)?i:0;a<n?n-=a:(t.textContent=(null!=(c=t.textContent)?c:"").substring(0,n)+"...",n=0)}};return o(r.body),r.body.innerHTML}var h=function(t){function e(){for(var e,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(e=t.call.apply(t,[this].concat(n))||this).post=void 0,e.length=void 0,e.richExcerpt=void 0,e}var r,n;n=t,(r=e).prototype=Object.create(n.prototype),r.prototype.constructor=r,u(r,n);var o=e.prototype;return o.oninit=function(e){t.prototype.oninit.call(this,e),this.post=this.attrs.post,this.length=this.attrs.length,this.richExcerpt=this.attrs.richExcerpt},o.view=function(){return m("div",{className:"Synopsis-excerpt",style:{visibility:"hidden"},oncreate:this.processExcerptDOM.bind(this),onupdate:this.processExcerptDOM.bind(this)},this.getContent())},o.getContent=function(){var t;if(this.richExcerpt){var e,r=null!=(e=this.contentRich())?e:"";return m.trust(f(r,this.length))}return(0,d.truncate)(null!=(t=this.contentPlain())?t:"",this.length)},o.contentRich=function(){return this.post.contentHtml()},o.contentPlain=function(){return this.post.contentPlain()},o.ensureSrc=function(t){var e,r=t.getAttribute("data-src")||t.getAttribute("data-original")||t.getAttribute("data-lazy")||t.getAttribute("data-url");!t.getAttribute("src")&&r&&t.setAttribute("src",r);var n="picture"===(null==(e=t.parentElement)||null==(e=e.tagName)?void 0:e.toLowerCase())?t.parentElement:null;n&&n.querySelectorAll("source").forEach(function(t){var e=t.getAttribute("data-srcset");e&&!t.getAttribute("srcset")&&t.setAttribute("srcset",e)})},o.processExcerptDOM=function(t){var e=this,r=t.dom;if(this.richExcerpt)if("1"!==r.dataset.synopsisClamped){var n=Array.from(r.querySelectorAll("img")).filter(function(t){return!t.classList.contains("emoji")});n.forEach(function(t,r){r<3?(e.ensureSrc(t),t.loading="lazy",t.decoding="async"):t.remove()});var o=[];r.childNodes.forEach(function(t){if(1===t.nodeType){var e,r=(null==(e=t.textContent)?void 0:e.trim())||"";""!==r&&"..."!==r||t.querySelector("img")||o.push(t)}}),o.forEach(function(t){return t.remove()});var i=Math.max(0,n.length-3);if(i>0&&!r.querySelector(".synopsis-extra-badge")){var s=document.createElement("span");s.className="synopsis-extra-badge",s.textContent="+"+i,r.appendChild(s)}r.dataset.synopsisClamped="1",r.style.visibility="visible"}else r.style.visibility="visible";else r.style.visibility="visible"},e}(p());const y=flarum.core.compat["common/extenders"];var v=t.n(y);const g=flarum.core.compat["tags/common/models/Tag"];var b=t.n(g);const x=[new(v().Model)(b()).attribute("richExcerpts").attribute("excerptLength")],E=[].concat(x);var N={Excerpt:h},P={truncateHtml:f};n().initializers.add("fof-synopsis",function(){(0,o.extend)(s().prototype,"requestParams",function(t){"string"==typeof t.include?t.include=[t.include]:t.include=t.include||[],"first"===n().forum.attribute("synopsis.excerpt_type")?t.include.push("firstPost"):t.include.push("lastPost")}),(0,o.extend)(a().prototype,"infoItems",function(t){if(!n().forum.attribute("synopsis.disable_when_searching")||!n().discussions.params.q){var e=this.attrs.discussion,r=e.tags()||[],o="first"===n().forum.attribute("synopsis.excerpt_type")?e.firstPost():e.lastPost(),i=r.filter(function(t){return t&&"function"==typeof t.excerptLength}).map(function(t){return t.excerptLength()}).filter(function(t){return"number"==typeof t}),s=i.length>0?Math.min.apply(Math,i):n().forum.attribute("synopsis.excerpt_length"),c=r.filter(function(t){return t&&"function"==typeof t.richExcerpts}).map(function(t){return t.richExcerpts()}),a=n().forum.attribute("synopsis.rich_excerpts");c.includes(!1)&&(a=!1),0!==s&&o&&t.add("excerpt",m(h,{post:o,length:s,richExcerpt:a}),-100)}})})})(),module.exports=e})();
//# sourceMappingURL=forum.js.map