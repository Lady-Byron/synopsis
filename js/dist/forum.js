(()=>{var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e),t.d(e,{components:()=>A,extend:()=>N,utils:()=>P});const r=flarum.core.compat["forum/app"];var n=t.n(r);const o=flarum.core.compat["common/extend"],i=flarum.core.compat["forum/states/DiscussionListState"];var s=t.n(i);const a=flarum.core.compat["forum/components/DiscussionListItem"];var c=t.n(a);function u(t,e){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},u(t,e)}const l=flarum.core.compat["common/Component"];var d=t.n(l);const p=flarum.core.compat["common/utils/string"];var f=new Map;function y(t,e,r){void 0===r&&(r=1);var n=e+":"+r+":"+t,o=f.get(n);if(void 0!==o)return f.delete(n),f.set(n,o),o;var i=(new DOMParser).parseFromString(t,"text/html"),s=Array.from(i.body.querySelectorAll("img")).filter(function(t){return!t.classList.contains("emoji")}),a=s.length;s.forEach(function(t,e){if(e>=r)t.remove();else{var n=t.getAttribute("data-src")||t.getAttribute("data-original")||t.getAttribute("data-lazy")||t.getAttribute("data-url");!t.getAttribute("src")&&n&&t.setAttribute("src",n),t.loading="lazy",t.decoding="async"}});var c=e,u=function(t){if(c<=0){var e,r,n;if("IMG"===t.nodeName)return void(t.classList.contains("emoji")&&(null==(e=t.parentNode)||e.removeChild(t)));if("PICTURE"===t.nodeName)return;if(t.nodeType===Node.TEXT_NODE)return void(null==(r=t.parentNode)||r.removeChild(t));t.childNodes.length>0&&Array.from(t.childNodes).forEach(u),0===t.childNodes.length&&"IMG"!==t.nodeName&&"PICTURE"!==t.nodeName&&(null==(n=t.parentNode)||n.removeChild(t))}else if(t.nodeType!==Node.TEXT_NODE)Array.from(t.childNodes).forEach(u);else{var o,i,s,a=null!=(o=null==(i=t.textContent)?void 0:i.length)?o:0;a<c?c-=a:(t.textContent=(null!=(s=t.textContent)?s:"").substring(0,c)+"...",c=0)}};u(i.body);var l=[];i.body.childNodes.forEach(function(t){if(1===t.nodeType){var e,r=(null==(e=t.textContent)?void 0:e.trim())||"";""!==r&&"..."!==r||t.querySelector("img")||l.push(t)}}),l.forEach(function(t){return t.remove()});var d={html:i.body.innerHTML,totalImages:a};if(f.size>=100){var p=f.keys().next().value;p&&f.delete(p)}return f.set(n,d),d}var v=function(t){function e(){for(var e,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(e=t.call.apply(t,[this].concat(n))||this).boundProcessDOM=void 0,e}var r,o;o=t,(r=e).prototype=Object.create(o.prototype),r.prototype.constructor=r,u(r,o);var i=e.prototype;return i.oninit=function(e){t.prototype.oninit.call(this,e),this.boundProcessDOM=this.processExcerptDOM.bind(this)},i.view=function(){var t=this.attrs.isNsfw;return m("div",{className:"Synopsis-excerpt"+(t?" synopsis-nsfw":""),style:{visibility:"hidden"},oncreate:this.boundProcessDOM,onupdate:this.boundProcessDOM},this.getContent())},i.getContent=function(){var t,e=this.attrs,r=e.post,n=e.length;if(e.richExcerpt){var o,i=null!=(o=r.contentHtml())?o:"";return m.trust(y(i,n))}return(0,p.truncate)(null!=(t=r.contentPlain())?t:"",n)},i.ensureSrc=function(t){var e,r=t.getAttribute("data-src")||t.getAttribute("data-original")||t.getAttribute("data-lazy")||t.getAttribute("data-url");!t.getAttribute("src")&&r&&t.setAttribute("src",r);var n="picture"===(null==(e=t.parentElement)||null==(e=e.tagName)?void 0:e.toLowerCase())?t.parentElement:null;n&&n.querySelectorAll("source").forEach(function(t){var e=t.getAttribute("data-srcset");e&&!t.getAttribute("srcset")&&t.setAttribute("srcset",e)})},i.processExcerptDOM=function(t){var e,r,o,i=this,s=t.dom,a=this.attrs,c=a.post;if(a.richExcerpt){var u=null!=(e=null==c||null==c.id?void 0:c.id())?e:"",l=s.dataset.synopsisPostId;if("1"!==s.dataset.synopsisClamped||l!==u){if(l&&l!==u){var d=s.querySelector(".synopsis-extra-badge");d&&d.remove()}var p=null!=(r=n().forum.attribute("synopsis.image_limit"))?r:3,f=Array.from(s.querySelectorAll("img")).filter(function(t){return!t.classList.contains("emoji")});f.forEach(function(t,e){e<p?(i.ensureSrc(t),t.loading="lazy",t.decoding="async"):t.remove()});var m=[];s.childNodes.forEach(function(t){if(1===t.nodeType){var e,r=(null==(e=t.textContent)?void 0:e.trim())||"";""!==r&&"..."!==r||t.querySelector("img")||m.push(t)}}),m.forEach(function(t){return t.remove()});var y=Math.max(0,f.length-p);if(y>0&&!s.querySelector(".synopsis-extra-badge")){var v=document.createElement("span");v.className="synopsis-extra-badge",v.textContent="+"+y,s.appendChild(v)}s.dataset.synopsisClamped="1",s.dataset.synopsisPostId=null!=(o=null==c||null==c.id?void 0:c.id())?o:"",s.style.visibility="visible"}else s.style.visibility="visible"}else s.style.visibility="visible"},e}(d());const h=flarum.core.compat["common/extenders"];var b=t.n(h);const g=flarum.core.compat["tags/common/models/Tag"];var x=t.n(g);const E=[new(b().Model)(x()).attribute("richExcerpts").attribute("excerptLength").attribute("isNsfw")],N=[].concat(E);var A={Excerpt:v},P={truncateHtml:y};n().initializers.add("fof-synopsis",function(){(0,o.extend)(s().prototype,"requestParams",function(t){"string"==typeof t.include?t.include=[t.include]:t.include=t.include||[],"first"===n().forum.attribute("synopsis.excerpt_type")?t.include.push("firstPost"):t.include.push("lastPost")}),(0,o.extend)(c().prototype,"infoItems",function(t){if(!n().forum.attribute("synopsis.disable_when_searching")||!n().discussions.params.q){var e=this.attrs.discussion,r=e.tags()||[],o="first"===n().forum.attribute("synopsis.excerpt_type")?e.firstPost():e.lastPost(),i=r.filter(function(t){return t&&"function"==typeof t.excerptLength}).map(function(t){return t.excerptLength()}).filter(function(t){return"number"==typeof t}),s=i.length>0?Math.min.apply(Math,i):n().forum.attribute("synopsis.excerpt_length"),a=r.filter(function(t){return t&&"function"==typeof t.richExcerpts}).map(function(t){return t.richExcerpts()}),c=n().forum.attribute("synopsis.rich_excerpts");a.includes(!1)&&(c=!1);var u=r.filter(function(t){return t&&"function"==typeof t.isNsfw}).map(function(t){return t.isNsfw()}).includes(!0);0!==s&&o&&t.add("excerpt",m(v,{post:o,length:s,richExcerpt:c,isNsfw:u}),-100)}})})})(),module.exports=e})();
//# sourceMappingURL=forum.js.map