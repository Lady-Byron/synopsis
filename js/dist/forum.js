(()=>{var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e),t.d(e,{components:()=>N,extend:()=>E,utils:()=>P});const r=flarum.core.compat["forum/app"];var n=t.n(r);const o=flarum.core.compat["common/extend"],i=flarum.core.compat["forum/states/DiscussionListState"];var s=t.n(i);const a=flarum.core.compat["forum/components/DiscussionListItem"];var c=t.n(a);function l(t,e){return l=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},l(t,e)}const u=flarum.core.compat["common/Component"];var p=t.n(u);const d=flarum.core.compat["common/utils/string"];function f(t,e){var r=(new DOMParser).parseFromString(t,"text/html"),n=e,o=function(t){if(n<=0){var e,r,i;if("IMG"===t.nodeName)return void(t.classList.contains("emoji")&&(null==(e=t.parentNode)||e.removeChild(t)));if("PICTURE"===t.nodeName)return;if(t.nodeType===Node.TEXT_NODE)return void(null==(r=t.parentNode)||r.removeChild(t));t.childNodes.length>0&&Array.from(t.childNodes).forEach(o),0===t.childNodes.length&&"IMG"!==t.nodeName&&"PICTURE"!==t.nodeName&&(null==(i=t.parentNode)||i.removeChild(t))}else if(t.nodeType!==Node.TEXT_NODE)Array.from(t.childNodes).forEach(o);else{var s,a,c,l=null!=(s=null==(a=t.textContent)?void 0:a.length)?s:0;l<n?n-=l:(t.textContent=(null!=(c=t.textContent)?c:"").substring(0,n)+"...",n=0)}};return o(r.body),r.body.innerHTML}var h=function(t){function e(){for(var e,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(e=t.call.apply(t,[this].concat(n))||this).post=void 0,e.length=void 0,e.richExcerpt=void 0,e}var r,o;o=t,(r=e).prototype=Object.create(o.prototype),r.prototype.constructor=r,l(r,o);var i=e.prototype;return i.oninit=function(e){t.prototype.oninit.call(this,e),this.post=this.attrs.post,this.length=this.attrs.length,this.richExcerpt=this.attrs.richExcerpt},i.view=function(){return m("div",{className:"Synopsis-excerpt",style:{visibility:"hidden"},oncreate:this.processExcerptDOM.bind(this),onupdate:this.processExcerptDOM.bind(this)},this.getContent())},i.getContent=function(){var t;if(this.richExcerpt){var e,r=null!=(e=this.contentRich())?e:"";return m.trust(f(r,this.length))}return(0,d.truncate)(null!=(t=this.contentPlain())?t:"",this.length)},i.contentRich=function(){return this.post.contentHtml()},i.contentPlain=function(){return this.post.contentPlain()},i.ensureSrc=function(t){var e,r=t.getAttribute("data-src")||t.getAttribute("data-original")||t.getAttribute("data-lazy")||t.getAttribute("data-url");!t.getAttribute("src")&&r&&t.setAttribute("src",r);var n="picture"===(null==(e=t.parentElement)||null==(e=e.tagName)?void 0:e.toLowerCase())?t.parentElement:null;n&&n.querySelectorAll("source").forEach(function(t){var e=t.getAttribute("data-srcset");e&&!t.getAttribute("srcset")&&t.setAttribute("srcset",e)})},i.processExcerptDOM=function(t){var e,r,o,i,s,a=this,c=t.dom;if(this.richExcerpt){var l=null!=(e=null==(r=this.post)||null==r.id?void 0:r.id())?e:"",u=c.dataset.synopsisPostId;if("1"!==c.dataset.synopsisClamped||u!==l){if(u&&u!==l){var p=c.querySelector(".synopsis-extra-badge");p&&p.remove()}var d=null!=(o=n().forum.attribute("synopsis.image_limit"))?o:3,f=Array.from(c.querySelectorAll("img")).filter(function(t){return!t.classList.contains("emoji")});f.forEach(function(t,e){e<d?(a.ensureSrc(t),t.loading="lazy",t.decoding="async"):t.remove()});var m=[];c.childNodes.forEach(function(t){if(1===t.nodeType){var e,r=(null==(e=t.textContent)?void 0:e.trim())||"";""!==r&&"..."!==r||t.querySelector("img")||m.push(t)}}),m.forEach(function(t){return t.remove()});var h=Math.max(0,f.length-d);if(h>0&&!c.querySelector(".synopsis-extra-badge")){var y=document.createElement("span");y.className="synopsis-extra-badge",y.textContent="+"+h,c.appendChild(y)}c.dataset.synopsisClamped="1",c.dataset.synopsisPostId=null!=(i=null==(s=this.post)||null==s.id?void 0:s.id())?i:"",c.style.visibility="visible"}else c.style.visibility="visible"}else c.style.visibility="visible"},e}(p());const y=flarum.core.compat["common/extenders"];var v=t.n(y);const g=flarum.core.compat["tags/common/models/Tag"];var b=t.n(g);const x=[new(v().Model)(b()).attribute("richExcerpts").attribute("excerptLength")],E=[].concat(x);var N={Excerpt:h},P={truncateHtml:f};n().initializers.add("fof-synopsis",function(){(0,o.extend)(s().prototype,"requestParams",function(t){"string"==typeof t.include?t.include=[t.include]:t.include=t.include||[],"first"===n().forum.attribute("synopsis.excerpt_type")?t.include.push("firstPost"):t.include.push("lastPost")}),(0,o.extend)(c().prototype,"infoItems",function(t){if(!n().forum.attribute("synopsis.disable_when_searching")||!n().discussions.params.q){var e=this.attrs.discussion,r=e.tags()||[],o="first"===n().forum.attribute("synopsis.excerpt_type")?e.firstPost():e.lastPost(),i=r.filter(function(t){return t&&"function"==typeof t.excerptLength}).map(function(t){return t.excerptLength()}).filter(function(t){return"number"==typeof t}),s=i.length>0?Math.min.apply(Math,i):n().forum.attribute("synopsis.excerpt_length"),a=r.filter(function(t){return t&&"function"==typeof t.richExcerpts}).map(function(t){return t.richExcerpts()}),c=n().forum.attribute("synopsis.rich_excerpts");a.includes(!1)&&(c=!1),0!==s&&o&&t.add("excerpt",m(h,{post:o,length:s,richExcerpt:c}),-100)}})})})(),module.exports=e})();
//# sourceMappingURL=forum.js.map