(()=>{var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e),t.d(e,{components:()=>_,extend:()=>E,utils:()=>P});const r=flarum.core.compat["forum/app"];var n=t.n(r);const o=flarum.core.compat["common/extend"],i=flarum.core.compat["forum/states/DiscussionListState"];var s=t.n(i);const a=flarum.core.compat["forum/components/DiscussionListItem"];var u=t.n(a);function c(t,e){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},c(t,e)}const l=flarum.core.compat["common/Component"];var f=t.n(l);const p=flarum.core.compat["common/utils/string"];var d=new Map;function h(t,e,r){void 0===r&&(r=1);var n=e+":"+r+":"+t,o=d.get(n);if(void 0!==o)return d.delete(n),d.set(n,o),o;var i=(new DOMParser).parseFromString(t,"text/html"),s=Array.from(i.body.querySelectorAll("img")).filter(function(t){return!t.classList.contains("emoji")}),a=s.length;s.forEach(function(t,e){if(e>=r)t.remove();else{var n=t.getAttribute("data-src")||t.getAttribute("data-original")||t.getAttribute("data-lazy")||t.getAttribute("data-url");!t.getAttribute("src")&&n&&t.setAttribute("src",n),t.loading="lazy",t.decoding="async"}});var u=e,c=function(t){if(u<=0){var e,r,n;if("IMG"===t.nodeName)return void(t.classList.contains("emoji")&&(null==(e=t.parentNode)||e.removeChild(t)));if("PICTURE"===t.nodeName)return;if(t.nodeType===Node.TEXT_NODE)return void(null==(r=t.parentNode)||r.removeChild(t));t.childNodes.length>0&&Array.from(t.childNodes).forEach(c),0===t.childNodes.length&&"IMG"!==t.nodeName&&"PICTURE"!==t.nodeName&&(null==(n=t.parentNode)||n.removeChild(t))}else if(t.nodeType!==Node.TEXT_NODE)Array.from(t.childNodes).forEach(c);else{var o,i,s,a=null!=(o=null==(i=t.textContent)?void 0:i.length)?o:0;a<u?u-=a:(t.textContent=(null!=(s=t.textContent)?s:"").substring(0,u)+"...",u=0)}};c(i.body);var l=[];i.body.childNodes.forEach(function(t){if(1===t.nodeType){var e,r=(null==(e=t.textContent)?void 0:e.trim())||"";""!==r&&"..."!==r||t.querySelector("img")||l.push(t)}}),l.forEach(function(t){return t.remove()});var f={html:i.body.innerHTML,totalImages:a};if(d.size>=100){var p=d.keys().next().value;p&&d.delete(p)}return d.set(n,f),f}var y=function(t){function e(){for(var e,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(e=t.call.apply(t,[this].concat(n))||this).truncateResult=null,e}var r,o;o=t,(r=e).prototype=Object.create(o.prototype),r.prototype.constructor=r,c(r,o);var i=e.prototype;return i.view=function(){var t=this.attrs,e=t.isNsfw,r=(t.richExcerpt,"Synopsis-excerpt"+(e?" synopsis-nsfw":"")),n=this.getContent(),o=this.getExtraBadge();return m("div",{className:r},n,o)},i.getContent=function(){var t,e=this.attrs,r=e.post,o=e.length;if(e.richExcerpt){var i,s,a=null!=(i=r.contentHtml())?i:"",u=null!=(s=n().forum.attribute("synopsis.image_limit"))?s:1;return this.truncateResult=h(a,o,u),m.trust(this.truncateResult.html)}return this.truncateResult=null,(0,p.truncate)(null!=(t=r.contentPlain())?t:"",o)},i.getExtraBadge=function(){var t;if(!this.truncateResult)return null;var e=null!=(t=n().forum.attribute("synopsis.image_limit"))?t:1,r=Math.max(0,this.truncateResult.totalImages-e);return r>0?m("span",{className:"synopsis-extra-badge"},"+",r):null},e}(f());const v=flarum.core.compat["common/extenders"];var g=t.n(v);const b=flarum.core.compat["tags/common/models/Tag"];var x=t.n(b);const N=[new(g().Model)(x()).attribute("richExcerpts").attribute("excerptLength").attribute("isNsfw")],E=[].concat(N);var _={Excerpt:y},P={truncateHtml:h};n().initializers.add("fof-synopsis",function(){(0,o.extend)(s().prototype,"requestParams",function(t){"string"==typeof t.include?t.include=[t.include]:t.include=t.include||[],"first"===n().forum.attribute("synopsis.excerpt_type")?t.include.push("firstPost"):t.include.push("lastPost")}),(0,o.extend)(u().prototype,"infoItems",function(t){if(!n().forum.attribute("synopsis.disable_when_searching")||!n().discussions.params.q){var e=this.attrs.discussion,r=e.tags()||[],o="first"===n().forum.attribute("synopsis.excerpt_type")?e.firstPost():e.lastPost(),i=r.filter(function(t){return t&&"function"==typeof t.excerptLength}).map(function(t){return t.excerptLength()}).filter(function(t){return"number"==typeof t}),s=i.length>0?Math.min.apply(Math,i):n().forum.attribute("synopsis.excerpt_length"),a=r.filter(function(t){return t&&"function"==typeof t.richExcerpts}).map(function(t){return t.richExcerpts()}),u=n().forum.attribute("synopsis.rich_excerpts");a.includes(!1)&&(u=!1);var c=r.filter(function(t){return t&&"function"==typeof t.isNsfw}).map(function(t){return t.isNsfw()}).includes(!0);0!==s&&o&&t.add("excerpt",m(y,{post:o,length:s,richExcerpt:u,isNsfw:c}),-100)}})})})(),module.exports=e})();
//# sourceMappingURL=forum.js.map